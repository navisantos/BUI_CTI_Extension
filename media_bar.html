<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Web</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"></link>	
	<link rel="stylesheet" type="text/css" href="./styles.css">
</head>
<body>
	<div id="cti-container">
		<div id="cti-search">
		  <table>
			<tr>
			  <td><b>Incoming Call:</b> <input type="text" id="phoneTxt" /></td>
			  <td><button id="acceptBtn">Accept Call</button></td>
			  <td><input type="checkbox" id="createInc" name="createInc">Create Incident</td>
			</tr>
		  </table>
		</div>		
		<div id="cti-calls">
			<b>Ongoing Calls:</b><ul style="list-style: none;display:flex" id="calls">
			</ul>
		</div>
	</div>
</body>

<!-- Taps into the REST API -->
<script type="text/javascript" src="./osvc_node.js"></script>	
<!-- Rendering Library -->
<script type="text/javascript" src="./vue.js"></script>	
<!-- Media bar HTML -->
<script type="text/x-template" id="cti-searchbar">
	<div id="cti-search">
	  <table>
		<tr>
		  <td><b>Incoming Call:</b> <input type="text" id="phoneTxt" /></td>
		  <td><button id="acceptBtn">Accept Call</button></td>
		  <td><input type="checkbox" id="createInc" name="createInc">Create Incident</td>
		</tr>
	  </table>
	</div>		
	<div id="cti-calls">
		<b>Ongoing Calls:</b><ul style="list-style: none;display:flex" id="calls">
		</ul>
	</div>
</script>


<script>
	
	const osvcNode = require('osvc_node');
	var workspaceRecordMap = {};
	var phoneNum = "";
	var result = "";
	var createIncident = false;
	var globalContext = null;
	var rnClient = {};
	
	const contextData = async () =>{
		let sdk = await ORACLE_SERVICE_CLOUD.extension_loader.load("Sample_CTI_MediaBar_Extension", "1");
		globalContext = await sdk.getGlobalContext();
		let intName = document.location.host.split(".")[0];
		let sessionID = await globalContext.getSessionToken();
		rnClient = osvcNode.Client({
			interface: intName,
			session: sessionID,
			version: 'v1.4'
		});
	}

	contextData().then(()=>{
		console.log("Context Data loaded");
	})


	document.getElementById("acceptBtn").addEventListener('click',async function(){			
	
		console.log("Button Clicked! " + document.getElementById('phoneTxt').value + "--" + document.getElementById('createInc').checked);
		createIncident = document.getElementById('createInc').checked;
		
		if(document.getElementById("phoneTxt").value == "") 
		{
			alert("Please enter a phone number!");
			return;
		}
		else {
			phoneNum = document.getElementById("phoneTxt").value;
			var count = "";
			
			//lookup contact					
			let jsonData = await contactLookup(phoneNum);
			console.log(jsonData);
			result = jsonData;
			count = jsonData.length;
			
			
			//print result count					
			console.log(count);
			
				// actions
				switch(count) {
					case 0:
						console.log("new record");
						if(!createIncident){
							openContactRecord(0,phoneNum).then(()=>{
								console.log("Opening Contact Record");
							});
						} else {
							let contactJsonObj = await createContactRecord(phoneNum);
							console.log(' Contact Id:'+ contactJsonObj.id);
							let incidentJsonObj = await createIncidentRecord(contactJsonObj.id);
							await openWorkspaceRecord('Incident',incidentJsonObj.id,phoneNum);
						}
						break;
					case 1:
						console.log("Open Contact: " + result[0].id);
						if(!createIncident){
							await openContactRecord(result[0].id,phoneNum);
						} else {
							let incidentJsonObj = await createIncidentRecord(result[0].id)
							await openWorkspaceRecord('Incident',incidentJsonObj.id,phoneNum);
						}
						break;
					default:
						console.log("Multiple records or something broke..open report");
						openReport();
						break;
				}
		}
	});	
	
	// check if contact exists in the db
	const contactLookup = async (phoneNumber)=>{
		let options = {
			client: rnClient,
			query: `SELECT id FROM contacts WHERE phones.phonelist.number='${phoneNumber}'`,
			annotation: "Querying phone number"
		}
		return await osvcNode.QueryResults.query(options);
	}
	
	//open workspace record..
	const openContactRecord = async (recordID,phoneNum) =>{
		console.log("Opening record ID : " + recordID);
		let extensionProvider = await ORACLE_SERVICE_CLOUD.extension_loader.load("MSE_CTI_MediaBar" , "1")
		extensionProvider.registerWorkspaceExtension(function(WorkspaceRecord) {						
			if(recordID === 0) { //new record
				WorkspaceRecord.createWorkspaceRecord('Contact', function(workspaceRecord){
					addWorkspaceButton(workspaceRecord,phoneNum);
					//set phone field
					WorkspaceRecord.updateField('Contact.PhOffice', phoneNum);
				}); 
			}
			else {
				WorkspaceRecord.editWorkspaceRecord('Contact', recordID, function(workspaceRecord){
					addWorkspaceButton(workspaceRecord,phoneNum);
				});
			}
		});
	}
						
	//open report..filter by phone
	const openReport = async (reportId) => {
		let sdk = await ORACLE_SERVICE_CLOUD.extension_loader.load('contactSearchExtension');
		sdk.registerAnalyticsExtension(async function(analyticsContext){
			// contact report created with phone filter added to the list
			let extensionReport = await analyticsContext.createReport(reportId);
			let filterList = extensionReport.getReportFilters().getFilterList();
			filterList[0].setValue(phoneNum);
			extensionReport.executeReport();
			console.log(filterList);
		});
	}

	const createIncidentRecord = async (contactId) =>{
		let options = {
			client: rnClient,
			url: "incidents",
			annotation: "creating incident record",
			json: {
				primaryContact: {
				id: parseInt(contactId)
			},
				subject: "CTI Incident"
			}
		}

		return await osvcNode.Connect.post(options);
	}
	
	const createContactRecord = async (contactNumber)=> {
		let options = {
			client: rnClient,
			url: "contacts",
			annotation: "creating contact record",
			json: {
				name : {
					first: 'unknown',
					last: 'contact'
				},
				phones :[
					{
						number: contactNumber,
						phoneType: {
							id:1
						}
					}
				]
			}
		}
		return await osvcNode.Connect.post(options);
	}
	
	const openWorkspaceRecord = async(workspaceType,contactId,phoneNum)=>{
		let extensionProvider = await ORACLE_SERVICE_CLOUD.extension_loader.load("Sample_CTI_MediaBar_Extension", "1");
		extensionProvider.registerWorkspaceExtension((workspaceRecord) => {
			workspaceRecord.editWorkspaceRecord(workspaceType,contactId,(workspaceRecord)=>{
					addWorkspaceButton(workspaceRecord,phoneNum);
				});
			}
		);
	}
	
	function addWorkspaceButton(workspaceRecord,phoneNum){
		workspaceRecordMap[workspaceRecord.getContextId()] = workspaceRecord;
		workspaceRecord.addRecordClosingListener(function(workspaceRecordEventParam){
			document.getElementById(workspaceRecord.getContextId()).remove();
		});
		document.getElementById("calls").append("<li class='tab' id='"+workspaceRecord.getContextId()+"' onclick='findAndFocus(\"" + workspaceRecord.getContextId() + "\")'><div class='focus'>"+phoneNum+"</div><sup><i class='fa fa-window-close' onclick='stopEvent();return closeCurrentWorkspace(\""+ workspaceRecord.getContextId() + "\")'></i></sup></li>");
	}
	
	const closeCurrentWorkspace = async(contextId) => {
		await workspaceRecordMap[contextId].closeEditor();
		document.getElementById(contextId).remove();
		workspaceRecordMap[contextId] = null;
		return false;
	}
	
	function findAndFocus(contextId){
		workspaceRecordMap[contextId].findAndFocus(workspaceRecordMap[contextId].getWorkspaceRecordType(),workspaceRecordMap[contextId].getWorkspaceRecordId());
	}
	
	function stopEvent(e){
		var evt = e ? e:window.event;
		if (evt.stopPropagation)    evt.stopPropagation();
		if (evt.cancelBubble!=null) evt.cancelBubble = true;
	}

	// Vue.component('blog-card', {
	// 	template: '#cti-searchbar',
	// });

	// new Vue({
	//   el: '#cti-container',
	// });

	</script>
</html>